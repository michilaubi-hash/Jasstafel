<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jass – Schiefertafel</title>
  <style>
    :root{
      --slate1:#0f1a14;
      --slate2:#0b1410;
      --chalk:#f3f6f1;
      --line:rgba(243,246,241,.26);
      --line-strong:rgba(243,246,241,.42);
      --glass:rgba(0,0,0,.18);
      --glass-strong: rgba(0,0,0,.42);
      --danger: rgba(255,120,120,.75);
      --ok: rgba(140,255,170,.65);
      --panel: rgba(8,12,10,.92);
      --panel2: rgba(0,0,0,.86);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--chalk);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--slate1), var(--slate2));
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    .wrap{
      width:min(980px, 100%);
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }

    button{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--chalk);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      min-width: 112px;
    }
    button:active{ transform: scale(.98); }
    button[disabled]{ opacity:.45; cursor:not-allowed; }

    .toggle.on{
      border-color: rgba(255,255,255,.55);
      background: rgba(255,255,255,.10);
    }
    .toggle.on.subtract{
      border-color: var(--danger);
      background: rgba(255,120,120,.12);
    }

    .board{
      flex:1;
      border:2px solid var(--line-strong);
      border-radius:22px;
      overflow:hidden;
      background:
        radial-gradient(900px 500px at 30% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(800px 450px at 80% 70%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.18));
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:relative;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .divider{
      height:2px;
      background: var(--line-strong);
      flex:0 0 auto;
      position:relative;
    }

    .sumChip{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
      pointer-events:none;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sumChip.top{
      top: calc(50% - 30px);
      transform: translateX(-50%) rotate(180deg);
    }
    .sumChip.bottom{
      top: calc(50% + 10px);
    }

    .sumLabel{
      opacity:.85;
      font-weight:900;
      font-size:13px;
      letter-spacing:.15px;
    }
    .sumNum{
      font-variant-numeric: tabular-nums;
      font-weight:1000;
      font-size:16px;
    }

    /* ZENTRALER +Runde Button (nur im verbesserten Modus sichtbar) */
    .centerAddWrap{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      pointer-events:none;
    }
    .centerAdd{
      pointer-events:auto;
      border:1px solid var(--line-strong);
      background: rgba(255,255,255,.10);
      padding:10px 14px;
      border-radius:999px;
      font-weight:1000;
      font-size:14px;
      min-width:auto;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .centerAdd.hidden{ display:none; }

    /* WICHTIG: Rest sitzt NUR in Zeile 1 rechts.
       50/20 spannen über beide Spalten => bis ganz nach rechts. */
    .teamPanel{
      flex:1 1 0;
      display:grid;
      grid-template-columns: 1fr 84px;   /* schmale Rest-Spalte */
      grid-template-rows: 1fr 1fr 1fr;   /* 100 / 50 / 20 */
      gap:8px;
      padding:10px;
      min-height:0;
    }

    .teamPanel.top{
      transform: rotate(180deg);
      transform-origin: center;
    }

    .zone{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      align-items:stretch;
      min-height:0;
      user-select:none;
      touch-action: manipulation;
      overflow:hidden;
    }
    .zone:active{ transform: scale(.99); }

    /* Schreibfläche: startet LINKS, wächst nach rechts; bei Overflow horizontal scroll (ohne Layout-Shift) */
    .write{
      width:100%;
      display:flex;
      align-items:flex-end;
      gap:6px;
      padding: 4px 2px 2px 2px;
      overflow-x:auto;
      overflow-y:hidden;
      flex-wrap:nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .write::-webkit-scrollbar{ display:none; }

    /* 100/20: 5er-Striche */
    .group{
      width:24px;
      height:44px;
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
    }
    .stroke{
      position:absolute;
      bottom:0;
      width:3px;
      height:44px;
      background: var(--chalk);
      border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
    }
    .s1{ left:1px; }
    .s2{ left:7px; }
    .s3{ left:13px; }
    .s4{ left:19px; }
    .diag{
      position:absolute;
      left:-1px;
      bottom:7px;
      width:26px;
      height:4px;
      background: var(--chalk);
      border-radius:2px;
      transform: rotate(-28deg);
      transform-origin:left center;
    }

    /* 50er: Kreuze DICHT */
    .mark50{
      width:16px;
      height:44px;
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
      margin-right:1px;
    }
    .slash{
      position:absolute;
      left:50%;
      top:4px;
      width:4px;
      height:38px;
      background: var(--chalk);
      border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
      transform-origin:center;
    }
    .slash.fwd{ transform: translateX(-54%) rotate(-20deg); }
    .slash.back{ transform: translateX(-46%) rotate(20deg); }

    /* Rest-Box nur oben rechts */
    .restCol{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
      justify-content:flex-start;
    }
    .restValue{
      text-align:right;
      font-weight:1000;
      font-size:15px;
      min-height: 18px;
      opacity:.95;
      font-variant-numeric: tabular-nums;
    }
    input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--chalk);
      padding:10px 7px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      outline:none;
    }
    .mutedEmpty{ opacity:0; }

    /* Positionierung im Grid */
    .z100{ grid-column:1; grid-row:1; }
    .rest{ grid-column:2; grid-row:1; }
    .z50{ grid-column:1 / 3; grid-row:2; }
    .z20{ grid-column:1 / 3; grid-row:3; }

    /* Modus: verbesserte Zählweise */
    .mode-improved .zone{ pointer-events:none; }
    .mode-improved .restCol input{ display:none; }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalBackdrop.open{ display:flex; }

    .modal{
      width: min(560px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 22px;
      box-shadow: 0 24px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .modalTitle{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .modalClose{
      min-width:auto;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }
    .modalBody{
      padding: 14px 16px 16px 16px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field{
      flex: 1 1 180px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-weight: 900;
      font-size: 12px;
      opacity: .85;
      letter-spacing: .1px;
    }
    .select, .num{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--chalk);
      padding: 10px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      outline:none;
    }
    .checks{
      display:flex;
      flex-direction:column;
      gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 10px;
      border-radius: 16px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      font-size: 13px;
      opacity: .95;
      user-select:none;
    }
    .check input{ width:18px; height:18px; }

    .modalFooter{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 12px 16px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.12);
    }
    .primary{
      border-color: rgba(255,255,255,.40);
      background: rgba(255,255,255,.12);
    }

    .hintBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 10px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight:900;
      font-size:13px;
      line-height:1.25;
      font-variant-numeric: tabular-nums;
    }
    .hintRow{ opacity:.92; }
    .hintSmall{ opacity:.75; font-size:12px; }

    /* Multiplier buttons */
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      width:100%;
    }
    .segBtn{
      flex:1 1 0;
      min-width: 0;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 13px;
      font-weight: 1000;
      text-align:center;
    }
    .segBtn.active{
      border-color: rgba(255,255,255,.45);
      background: rgba(255,255,255,.14);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    /* Team selection in add modal */
    .teamSeg .segBtn{
      padding: 10px 8px;
    }

    @media (max-width: 420px){
      .teamPanel{ grid-template-columns: 1fr 78px; gap:7px; padding:9px; }
      .sumChip{ font-size:15px; }
      .group{ width:22px; height:42px; }
      .stroke{ height:42px; }
      .diag{ width:24px; }
      .mark50{ width:15px; height:42px; }
      .slash{ height:36px; }
      .write{ gap:5px; }
      button{ min-width: 104px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <button class="toggle" id="btnMode" aria-pressed="false">Korrektur</button>
      <button id="btnReset">Reset</button>
      <button id="btnSettings">Einstellungen</button>
    </div>

    <div class="board" id="board" role="application" aria-label="Jass Schiefertafel">
      <div class="sumChip top">
        <span class="sumLabel">Oben</span>
        <span class="sumNum" id="sumTop">0</span>
      </div>
      <div class="sumChip bottom">
        <span class="sumLabel">Unten</span>
        <span class="sumNum" id="sumBottom">0</span>
      </div>

      <div class="centerAddWrap">
        <button class="centerAdd hidden" id="btnAddCenter">+ Runde</button>
      </div>

      <!-- OBEN -->
      <div class="teamPanel top" data-team="A" aria-label="Oben">
        <div class="zone z100" data-team="A" data-val="100"><div class="write" id="a100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restA"></div>
          <input id="restInputA" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="A" data-val="50"><div class="write" id="a50W"></div></div>
        <div class="zone z20" data-team="A" data-val="20"><div class="write" id="a20W"></div></div>
      </div>

      <div class="divider"></div>

      <!-- UNTEN -->
      <div class="teamPanel" data-team="B" aria-label="Unten">
        <div class="zone z100" data-team="B" data-val="100"><div class="write" id="b100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restB"></div>
          <input id="restInputB" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="B" data-val="50"><div class="write" id="b50W"></div></div>
        <div class="zone z20" data-team="B" data-val="20"><div class="write" id="b20W"></div></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Einstellungen -->
  <div class="modalBackdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Einstellungen">
      <div class="modalHeader">
        <div class="modalTitle">Einstellungen</div>
        <button class="modalClose" id="btnCloseSettings">Schliessen</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <div class="label">Zählmodus</div>
          <select class="select" id="modeSelect">
            <option value="improved">Verbesserte Zählweise (Standard)</option>
            <option value="classic">Klassische Tafel</option>
          </select>
        </div>
        <div class="hintBox">
          <div class="hintRow">Verbesserte Zählweise: „+ Runde“ → Punkte werden automatisch als Striche eingetragen (100/50/20/Rest).</div>
          <div class="hintRow">Klassische Tafel: Striche antippen + Restbetrag manuell.</div>
        </div>
      </div>
      <div class="modalFooter">
        <button id="btnSaveSettings" class="primary">Speichern</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Runde hinzufügen -->
  <div class="modalBackdrop" id="roundModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Runde hinzufügen">
      <div class="modalHeader">
        <div class="modalTitle" id="roundTitle">+ Runde</div>
        <button class="modalClose" id="btnCloseRound">Schliessen</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <div class="label">Für welches Team?</div>
          <div class="seg teamSeg" id="teamSeg">
            <button class="segBtn active" data-team="B" type="button">Unten</button>
            <button class="segBtn" data-team="A" type="button">Oben</button>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label">Gemachte Punkte</div>
            <input class="num" id="inpPoints" inputmode="numeric" autocomplete="off" placeholder="z.B. 84" />
          </div>
        </div>

        <div class="field">
          <div class="label">Multiplikator</div>
          <div class="seg" id="multSeg">
            <button class="segBtn active" data-m="1" type="button">1×</button>
            <button class="segBtn" data-m="2" type="button">2×</button>
            <button class="segBtn" data-m="3" type="button">3×</button>
            <button class="segBtn" data-m="4" type="button">4×</button>
          </div>
        </div>

        <div class="checks">
          <label class="check">
            <input type="checkbox" id="chkAutoOpp" checked />
            Gegner automatisch ergänzen (Total 157)
          </label>
          <label class="check">
            <input type="checkbox" id="chkMatch" />
            Match (257 / 0)
          </label>
        </div>

        <div class="hintBox" id="roundHint"></div>
      </div>

      <div class="modalFooter">
        <button id="btnAddRound" class="primary">Hinzufügen</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const LS_KEY_MODE = "jass_mode_v3";

      const state = {
        mode: "improved", // default
        subtract: false,

        // classic counters (used for display in BOTH modes)
        A: { c100: 0, c50: 0, c20: 0, rest: 0 },
        B: { c100: 0, c50: 0, c20: 0, rest: 0 },

        // improved sums (round additions accumulate here)
        improved: {
          A: { sum: 0 },
          B: { sum: 0 }
        },

        // round modal selections
        ui: {
          addTeam: "B",
          mult: 1
        }
      };

      const el = {
        board: document.getElementById('board'),

        btnMode: document.getElementById('btnMode'),
        btnReset: document.getElementById('btnReset'),
        btnSettings: document.getElementById('btnSettings'),

        btnAddCenter: document.getElementById('btnAddCenter'),

        sumTop: document.getElementById('sumTop'),
        sumBottom: document.getElementById('sumBottom'),

        restA: document.getElementById('restA'),
        restB: document.getElementById('restB'),
        restInputA: document.getElementById('restInputA'),
        restInputB: document.getElementById('restInputB'),

        a100W: document.getElementById('a100W'),
        a50W: document.getElementById('a50W'),
        a20W: document.getElementById('a20W'),
        b100W: document.getElementById('b100W'),
        b50W: document.getElementById('b50W'),
        b20W: document.getElementById('b20W'),

        // settings modal
        settingsModal: document.getElementById('settingsModal'),
        btnCloseSettings: document.getElementById('btnCloseSettings'),
        btnSaveSettings: document.getElementById('btnSaveSettings'),
        modeSelect: document.getElementById('modeSelect'),

        // round modal
        roundModal: document.getElementById('roundModal'),
        btnCloseRound: document.getElementById('btnCloseRound'),
        btnAddRound: document.getElementById('btnAddRound'),
        roundTitle: document.getElementById('roundTitle'),
        inpPoints: document.getElementById('inpPoints'),
        chkAutoOpp: document.getElementById('chkAutoOpp'),
        chkMatch: document.getElementById('chkMatch'),
        roundHint: document.getElementById('roundHint'),

        teamSeg: document.getElementById('teamSeg'),
        multSeg: document.getElementById('multSeg'),
      };

      // ---------- helpers ----------
      function clampMinZero(n){ return Math.max(0, n); }
      function teamSumClassic(t){ return (t.c100*100) + (t.c50*50) + (t.c20*20) + (t.rest || 0); }

      function setMaybeEmptyText(elm, value){
        if(!value){
          elm.textContent = "";
          elm.classList.add('mutedEmpty');
        } else {
          elm.textContent = String(value);
          elm.classList.remove('mutedEmpty');
        }
      }

      function openModal(backdropEl){
        backdropEl.classList.add('open');
        backdropEl.setAttribute('aria-hidden','false');
      }
      function closeModal(backdropEl){
        backdropEl.classList.remove('open');
        backdropEl.setAttribute('aria-hidden','true');
      }

      function loadMode(){
        const v = localStorage.getItem(LS_KEY_MODE);
        if(v === "classic" || v === "improved") state.mode = v;
      }
      function saveMode(){
        localStorage.setItem(LS_KEY_MODE, state.mode);
      }

      function sanitizeInt(text){
        const s = (text ?? "").toString().trim().replace(",", ".");
        if(!s) return null;
        const n = Number(s);
        if(!Number.isFinite(n)) return null;
        return Math.round(n);
      }

      // Decompose sum into 100/50/20/rest with "largest possible strokes"
      function decomposePoints(sum){
        let s = Math.max(0, Math.round(sum || 0));
        const c100 = Math.floor(s / 100); s -= c100 * 100;
        const c50  = Math.floor(s / 50);  s -= c50  * 50;
        const c20  = Math.floor(s / 20);  s -= c20  * 20;
        const rest = s;
        return { c100, c50, c20, rest };
      }

      // ---------- tally drawing ----------
      function makeTallyGroup(countInGroup){
        const g = document.createElement('div');
        g.className = 'group';
        if(countInGroup >= 1){ const s=document.createElement('div'); s.className='stroke s1'; g.appendChild(s); }
        if(countInGroup >= 2){ const s=document.createElement('div'); s.className='stroke s2'; g.appendChild(s); }
        if(countInGroup >= 3){ const s=document.createElement('div'); s.className='stroke s3'; g.appendChild(s); }
        if(countInGroup >= 4){ const s=document.createElement('div'); s.className='stroke s4'; g.appendChild(s); }
        if(countInGroup >= 5){ const d=document.createElement('div'); d.className='diag'; g.appendChild(d); }
        return g;
      }

      function renderTalliesTo(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const fullGroups = Math.floor(n / 5);
        const rest = n % 5;

        for(let i=0; i<fullGroups; i++) hostEl.appendChild(makeTallyGroup(5));
        if(rest > 0) hostEl.appendChild(makeTallyGroup(rest));
      }

      function makeMark50(type){
        const m = document.createElement('div');
        m.className = 'mark50';

        const a = document.createElement('div');
        a.className = 'slash fwd';
        m.appendChild(a);

        if(type === 'cross'){
          const b = document.createElement('div');
          b.className = 'slash back';
          m.appendChild(b);
        }
        return m;
      }

      function render50To(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const pairs = Math.floor(n / 2);
        const odd = n % 2;

        for(let i=0;i<pairs;i++) hostEl.appendChild(makeMark50('cross'));
        if(odd === 1) hostEl.appendChild(makeMark50('slash'));
      }

      // ---------- classic behavior ----------
      function bumpCount(teamKey, val){
        const t = state[teamKey];
        const delta = state.subtract ? -1 : 1;

        if(val === 100) t.c100 = clampMinZero(t.c100 + delta);
        if(val === 50)  t.c50  = clampMinZero(t.c50  + delta);
        if(val === 20)  t.c20  = clampMinZero(t.c20  + delta);

        render();
      }

      function parseRest(text){
        const s = (text ?? "").toString().trim().replace(",", ".");
        if(!s) return null;
        const n = Number(s);
        if(Number.isNaN(n)) return null;
        return n;
      }

      function commitRest(teamKey, inputEl){
        const n = parseRest(inputEl.value);
        if(n === null) return;
        state[teamKey].rest = n; // ersetzt
        inputEl.value = "";
        render();
      }

      // ---------- improved behavior ----------
      function teamSumImproved(teamKey){
        return Math.max(0, Math.round(state.improved[teamKey].sum || 0));
      }

      function syncClassicFromImproved(){
        // Write sums into classic counters (for automatic strokes)
        const a = decomposePoints(teamSumImproved("A"));
        const b = decomposePoints(teamSumImproved("B"));

        state.A.c100 = a.c100; state.A.c50 = a.c50; state.A.c20 = a.c20; state.A.rest = a.rest;
        state.B.c100 = b.c100; state.B.c50 = b.c50; state.B.c20 = b.c20; state.B.rest = b.rest;
      }

      function updateRoundHint(){
        const mult = state.ui.mult;
        const isMatch = el.chkMatch.checked;
        const autoOpp = el.chkAutoOpp.checked; // always 157 if checked
        const teamKey = state.ui.addTeam;
        const oppKey = (teamKey === "A") ? "B" : "A";

        if(isMatch){
          // Match base = 257 for own, 0 for opponent. Mult applies.
          const ownBase = 257;
          const ownAdd = ownBase * mult;

          el.inpPoints.disabled = true;
          el.chkAutoOpp.disabled = true;

          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: 0</div>
            <div class="hintSmall">Team: ${teamKey === "A" ? "Oben" : "Unten"} · Match</div>
          `;
          return;
        }

        el.inpPoints.disabled = false;
        el.chkAutoOpp.disabled = false;

        const pts = sanitizeInt(el.inpPoints.value);
        if(pts === null){
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: —</div>
            <div class="hintRow">Gegner: ${autoOpp ? "157 − Eigen (automatisch)" : "—"}</div>
            <div class="hintSmall">Multiplikator: ×${mult} · Team: ${teamKey === "A" ? "Oben" : "Unten"}</div>
          `;
          return;
        }

        const ownBase = pts;
        const ownAdd = ownBase * mult;

        if(autoOpp){
          const oppBase = Math.max(0, 157 - ownBase);
          const oppAdd = oppBase * mult;
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: ${oppBase} × ${mult} = ${oppAdd}</div>
            <div class="hintSmall">Auto-Gegner ergänzt immer auf 157.</div>
          `;
        } else {
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: —</div>
            <div class="hintSmall">Ohne Auto-Gegner wird nur Eigen addiert.</div>
          `;
        }
      }

      function addRound(){
        const mult = state.ui.mult;
        const isMatch = el.chkMatch.checked;
        const autoOpp = el.chkAutoOpp.checked;

        const teamKey = state.ui.addTeam;
        const oppKey = (teamKey === "A") ? "B" : "A";

        if(isMatch){
          const ownAdd = 257 * mult;
          state.improved[teamKey].sum += ownAdd;
          // opponent stays 0 even with multiplier (still 0)
          closeModal(el.roundModal);
          render();
          return;
        }

        const pts = sanitizeInt(el.inpPoints.value);
        if(pts === null){
          alert("Bitte Punkte eingeben (oder Match aktivieren).");
          return;
        }
        if(pts < 0 || pts > 257){
          alert("Punkte müssen zwischen 0 und 257 liegen.");
          return;
        }

        const ownAdd = pts * mult;
        state.improved[teamKey].sum += ownAdd;

        if(autoOpp){
          const oppBase = Math.max(0, 157 - pts);
          const oppAdd = oppBase * mult;
          state.improved[oppKey].sum += oppAdd;
        }

        // reset modal inputs
        el.inpPoints.value = "";
        el.chkMatch.checked = false;
        el.chkAutoOpp.checked = true;

        closeModal(el.roundModal);
        render();
      }

      // ---------- render ----------
      function applyModeUI(){
        const isImproved = (state.mode === "improved");

        el.board.classList.toggle("mode-improved", isImproved);

        // classic-only: correction button
        el.btnMode.style.display = isImproved ? "none" : "";
        el.btnMode.disabled = isImproved;

        // improved-only: center add
        el.btnAddCenter.classList.toggle("hidden", !isImproved);

        // set select
        el.modeSelect.value = state.mode;

        // entering improved => correction off
        if(isImproved) state.subtract = false;
      }

      function renderBoardFromClassicState(){
        renderTalliesTo(el.a100W, state.A.c100);
        render50To(el.a50W, state.A.c50);
        renderTalliesTo(el.a20W, state.A.c20);

        renderTalliesTo(el.b100W, state.B.c100);
        render50To(el.b50W, state.B.c50);
        renderTalliesTo(el.b20W, state.B.c20);

        setMaybeEmptyText(el.restA, state.A.rest);
        setMaybeEmptyText(el.restB, state.B.rest);

        el.sumTop.textContent = String(teamSumClassic(state.A));
        el.sumBottom.textContent = String(teamSumClassic(state.B));
      }

      function render(){
        applyModeUI();

        if(state.mode === "improved"){
          syncClassicFromImproved();
        }

        renderBoardFromClassicState();

        // classic UI state
        el.btnMode.classList.toggle('on', state.subtract);
        el.btnMode.classList.toggle('subtract', state.subtract);
        el.btnMode.setAttribute('aria-pressed', String(state.subtract));
        el.btnMode.textContent = state.subtract ? 'Korrektur: AN' : 'Korrektur';
      }

      // ---------- events ----------
      document.querySelectorAll('.zone').forEach(z => {
        z.addEventListener('click', () => {
          if(state.mode !== "classic") return;
          bumpCount(z.dataset.team, Number(z.dataset.val));
        }, { passive:true });
      });

      el.btnMode.addEventListener('click', () => {
        if(state.mode !== "classic") return;
        state.subtract = !state.subtract;
        render();
      });

      [ [el.restInputA,'A'], [el.restInputB,'B'] ].forEach(([inp, team]) => {
        inp.addEventListener('keydown', (e) => {
          if(e.key === 'Enter'){ e.preventDefault(); commitRest(team, inp); inp.blur(); }
        });
        inp.addEventListener('blur', () => commitRest(team, inp));
      });

      el.btnReset.addEventListener('click', () => {
        const ok = confirm("Wirklich alles zurücksetzen?");
        if(!ok) return;

        state.subtract = false;

        // classic
        state.A = { c100:0, c50:0, c20:0, rest:0 };
        state.B = { c100:0, c50:0, c20:0, rest:0 };

        // improved sums
        state.improved = {
          A: { sum: 0 },
          B: { sum: 0 }
        };

        el.restInputA.value = "";
        el.restInputB.value = "";

        render();
      });

      // settings modal
      el.btnSettings.addEventListener('click', () => openModal(el.settingsModal));
      el.btnCloseSettings.addEventListener('click', () => closeModal(el.settingsModal));
      el.settingsModal.addEventListener('click', (e) => {
        if(e.target === el.settingsModal) closeModal(el.settingsModal);
      });

      el.btnSaveSettings.addEventListener('click', () => {
        const v = el.modeSelect.value;
        state.mode = (v === "classic") ? "classic" : "improved";
        saveMode();
        closeModal(el.settingsModal);
        render();
      });

      // center add
      el.btnAddCenter.addEventListener('click', () => {
        // init modal defaults
        el.inpPoints.value = "";
        el.chkAutoOpp.checked = true;
        el.chkMatch.checked = false;

        // default team = unten
        state.ui.addTeam = "B";
        [...el.teamSeg.querySelectorAll('.segBtn')].forEach(b => {
          b.classList.toggle('active', b.dataset.team === state.ui.addTeam);
        });

        // default mult = 1
        state.ui.mult = 1;
        [...el.multSeg.querySelectorAll('.segBtn')].forEach(b => {
          b.classList.toggle('active', Number(b.dataset.m) === state.ui.mult);
        });

        updateRoundHint();
        openModal(el.roundModal);
        setTimeout(() => el.inpPoints.focus(), 60);
      });

      // round modal close/backdrop
      el.btnCloseRound.addEventListener('click', () => closeModal(el.roundModal));
      el.roundModal.addEventListener('click', (e) => {
        if(e.target === el.roundModal) closeModal(el.roundModal);
      });

      // team segmented
      el.teamSeg.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.addTeam = btn.dataset.team;
        [...el.teamSeg.querySelectorAll('.segBtn')].forEach(b => b.classList.toggle('active', b === btn));
        updateRoundHint();
      });

      // multiplier segmented
      el.multSeg.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.mult = Number(btn.dataset.m) || 1;
        [...el.multSeg.querySelectorAll('.segBtn')].forEach(b => b.classList.toggle('active', b === btn));
        updateRoundHint();
      });

      // round modal inputs
      el.inpPoints.addEventListener('input', updateRoundHint);
      el.chkAutoOpp.addEventListener('change', updateRoundHint);
      el.chkMatch.addEventListener('change', updateRoundHint);

      el.btnAddRound.addEventListener('click', addRound);

      // Enter adds round
      el.inpPoints.addEventListener('keydown', (e) => {
        if(e.key === "Enter"){
          e.preventDefault();
          addRound();
        }
      });

      // ESC closes modals
      document.addEventListener('keydown', (e) => {
        if(e.key === "Escape"){
          closeModal(el.settingsModal);
          closeModal(el.roundModal);
        }
      });

      // init
      loadMode();
      if(state.mode !== "classic" && state.mode !== "improved") state.mode = "improved";
      render();
    })();
  </script>
</body>
</html>
