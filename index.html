<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jass – Schiefertafel</title>
  <style>
    :root{
      --slate1:#0f1a14;
      --slate2:#0b1410;
      --chalk:#f3f6f1;
      --line:rgba(243,246,241,.26);
      --line-strong:rgba(243,246,241,.42);
      --glass:rgba(0,0,0,.18);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--chalk);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--slate1), var(--slate2));
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    .wrap{
      width:min(980px, 100%);
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }

    button{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--chalk);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      min-width: 112px;
    }
    button:active{ transform: scale(.98); }

    .toggle.on{
      border-color: rgba(255,255,255,.55);
      background: rgba(255,255,255,.10);
    }
    .toggle.on.subtract{
      border-color: rgba(255,120,120,.75);
      background: rgba(255,120,120,.12);
    }

    .board{
      flex:1;
      border:2px solid var(--line-strong);
      border-radius:22px;
      overflow:hidden;
      background:
        radial-gradient(900px 500px at 30% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(800px 450px at 80% 70%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.18));
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:relative;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .divider{
      height:2px;
      background: var(--line-strong);
      flex:0 0 auto;
    }

    .sumChip{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
      pointer-events:none;
    }
    .sumChip.top{
      top: calc(50% - 30px);
      transform: translateX(-50%) rotate(180deg);
    }
    .sumChip.bottom{
      top: calc(50% + 10px);
    }

    /* WICHTIG: Rest sitzt NUR in Zeile 1 rechts.
       50/20 spannen über beide Spalten => bis ganz nach rechts. */
    .teamPanel{
      flex:1 1 0;
      display:grid;
      grid-template-columns: 1fr 84px;   /* schmale Rest-Spalte */
      grid-template-rows: 1fr 1fr 1fr;   /* 100 / 50 / 20 */
      gap:8px;
      padding:10px;
      min-height:0;
    }

    .teamPanel.top{
      transform: rotate(180deg);
      transform-origin: center;
    }

    .zone{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      align-items:stretch;
      min-height:0;
      user-select:none;
      touch-action: manipulation;
      overflow:hidden;
    }
    .zone:active{ transform: scale(.99); }

    /* Schreibfläche: startet LINKS, wächst nach rechts; bei Overflow horizontal scroll (ohne Layout-Shift) */
    .write{
      width:100%;
      display:flex;
      align-items:flex-end;
      gap:6px;
      padding: 4px 2px 2px 2px;
      overflow-x:auto;
      overflow-y:hidden;
      flex-wrap:nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .write::-webkit-scrollbar{ display:none; }

    /* 100/20: 5er-Striche */
    .group{
      width:24px;
      height:44px;
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
    }
    .stroke{
      position:absolute;
      bottom:0;
      width:3px;
      height:44px;
      background: var(--chalk);
      border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
    }
    .s1{ left:1px; }
    .s2{ left:7px; }
    .s3{ left:13px; }
    .s4{ left:19px; }
    .diag{
      position:absolute;
      left:-1px;
      bottom:7px;
      width:26px;
      height:4px;
      background: var(--chalk);
      border-radius:2px;
      transform: rotate(-28deg);
      transform-origin:left center;
    }

    /* 50er: Kreuze DICHT (wenig Abstand zwischen Kreuzen) */
    .mark50{
      width:16px;   /* schmal */
      height:44px;
      position:relative;
      opacity:.95;
      flex: 0 0 auto;
      margin-right:1px; /* noch dichter */
    }
    .slash{
      position:absolute;
      left:50%;
      top:4px;
      width:4px;
      height:38px;
      background: var(--chalk);
      border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
      transform-origin:center;
    }
    .slash.fwd{ transform: translateX(-54%) rotate(-20deg); }
    .slash.back{ transform: translateX(-46%) rotate(20deg); }

    /* Rest-Box nur oben rechts */
    .restCol{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
      justify-content:flex-start;
    }
    .restValue{
      text-align:right;
      font-weight:1000;
      font-size:15px;
      min-height: 18px;
      opacity:.95;
    }
    input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--chalk);
      padding:10px 7px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      outline:none;
    }
    .mutedEmpty{ opacity:0; }

    /* Positionierung im Grid */
    .z100{ grid-column:1; grid-row:1; }
    .rest{ grid-column:2; grid-row:1; }
    .z50{ grid-column:1 / 3; grid-row:2; }  /* spannt voll bis rechts */
    .z20{ grid-column:1 / 3; grid-row:3; }  /* spannt voll bis rechts */

    @media (max-width: 420px){
      .teamPanel{ grid-template-columns: 1fr 78px; gap:7px; padding:9px; }
      .sumChip{ font-size:15px; }
      .group{ width:22px; height:42px; }
      .stroke{ height:42px; }
      .diag{ width:24px; }
      .mark50{ width:15px; height:42px; }
      .slash{ height:36px; }
      .write{ gap:5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <button class="toggle" id="btnMode" aria-pressed="false">Korrektur</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="board" role="application" aria-label="Jass Schiefertafel">
      <div class="sumChip top" id="sumTop">0</div>
      <div class="sumChip bottom" id="sumBottom">0</div>

      <!-- OBEN (Gegenspieler, auf dem Kopf) -->
      <div class="teamPanel top" data-team="A" aria-label="Oben">
        <div class="zone z100" data-team="A" data-val="100"><div class="write" id="a100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restA"></div>
          <input id="restInputA" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="A" data-val="50"><div class="write" id="a50W"></div></div>
        <div class="zone z20" data-team="A" data-val="20"><div class="write" id="a20W"></div></div>
      </div>

      <div class="divider"></div>

      <!-- UNTEN (du) -->
      <div class="teamPanel" data-team="B" aria-label="Unten">
        <div class="zone z100" data-team="B" data-val="100"><div class="write" id="b100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restB"></div>
          <input id="restInputB" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="B" data-val="50"><div class="write" id="b50W"></div></div>
        <div class="zone z20" data-team="B" data-val="20"><div class="write" id="b20W"></div></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const state = {
        subtract: false,
        A: { c100: 0, c50: 0, c20: 0, rest: 0 },
        B: { c100: 0, c50: 0, c20: 0, rest: 0 }
      };

      const el = {
        btnMode: document.getElementById('btnMode'),
        btnReset: document.getElementById('btnReset'),
        sumTop: document.getElementById('sumTop'),
        sumBottom: document.getElementById('sumBottom'),
        restA: document.getElementById('restA'),
        restB: document.getElementById('restB'),
        restInputA: document.getElementById('restInputA'),
        restInputB: document.getElementById('restInputB'),

        a100W: document.getElementById('a100W'),
        a50W: document.getElementById('a50W'),
        a20W: document.getElementById('a20W'),
        b100W: document.getElementById('b100W'),
        b50W: document.getElementById('b50W'),
        b20W: document.getElementById('b20W'),
      };

      function clampMinZero(n){ return Math.max(0, n); }
      function teamSum(t){ return (t.c100*100) + (t.c50*50) + (t.c20*20) + (t.rest || 0); }

      // 5er-Striche (100/20)
      function makeTallyGroup(countInGroup){
        const g = document.createElement('div');
        g.className = 'group';
        if(countInGroup >= 1){ const s=document.createElement('div'); s.className='stroke s1'; g.appendChild(s); }
        if(countInGroup >= 2){ const s=document.createElement('div'); s.className='stroke s2'; g.appendChild(s); }
        if(countInGroup >= 3){ const s=document.createElement('div'); s.className='stroke s3'; g.appendChild(s); }
        if(countInGroup >= 4){ const s=document.createElement('div'); s.className='stroke s4'; g.appendChild(s); }
        if(countInGroup >= 5){ const d=document.createElement('div'); d.className='diag'; g.appendChild(d); }
        return g;
      }

      function renderTalliesTo(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const fullGroups = Math.floor(n / 5);
        const rest = n % 5;

        for(let i=0; i<fullGroups; i++) hostEl.appendChild(makeTallyGroup(5));
        if(rest > 0) hostEl.appendChild(makeTallyGroup(rest));
      }

      // 50er: dichtes Kreuz / slash
      function makeMark50(type){
        const m = document.createElement('div');
        m.className = 'mark50';

        const a = document.createElement('div');
        a.className = 'slash fwd';
        m.appendChild(a);

        if(type === 'cross'){
          const b = document.createElement('div');
          b.className = 'slash back';
          m.appendChild(b);
        }
        return m;
      }

      function render50To(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const pairs = Math.floor(n / 2);
        const odd = n % 2;

        for(let i=0;i<pairs;i++) hostEl.appendChild(makeMark50('cross'));
        if(odd === 1) hostEl.appendChild(makeMark50('slash'));
      }

      function setMaybeEmptyText(elm, value){
        if(!value){
          elm.textContent = "";
          elm.classList.add('mutedEmpty');
        } else {
          elm.textContent = String(value);
          elm.classList.remove('mutedEmpty');
        }
      }

      function render(){
        renderTalliesTo(el.a100W, state.A.c100);
        render50To(el.a50W, state.A.c50);
        renderTalliesTo(el.a20W, state.A.c20);

        renderTalliesTo(el.b100W, state.B.c100);
        render50To(el.b50W, state.B.c50);
        renderTalliesTo(el.b20W, state.B.c20);

        setMaybeEmptyText(el.restA, state.A.rest);
        setMaybeEmptyText(el.restB, state.B.rest);

        el.sumTop.textContent = String(teamSum(state.A));
        el.sumBottom.textContent = String(teamSum(state.B));

        el.btnMode.classList.toggle('on', state.subtract);
        el.btnMode.classList.toggle('subtract', state.subtract);
        el.btnMode.setAttribute('aria-pressed', String(state.subtract));
        el.btnMode.textContent = state.subtract ? 'Korrektur: AN' : 'Korrektur';
      }

      function bumpCount(teamKey, val){
        const t = state[teamKey];
        const delta = state.subtract ? -1 : 1;

        if(val === 100) t.c100 = clampMinZero(t.c100 + delta);
        if(val === 50)  t.c50  = clampMinZero(t.c50  + delta);
        if(val === 20)  t.c20  = clampMinZero(t.c20  + delta);

        render();
      }

      document.querySelectorAll('.zone').forEach(z => {
        z.addEventListener('click', () => {
          bumpCount(z.dataset.team, Number(z.dataset.val));
        }, { passive:true });
      });

      el.btnMode.addEventListener('click', () => {
        state.subtract = !state.subtract;
        render();
      });

      function parseRest(text){
        const s = (text ?? "").toString().trim().replace(",", ".");
        if(!s) return null;
        const n = Number(s);
        if(Number.isNaN(n)) return null;
        return n;
      }

      function commitRest(teamKey, inputEl){
        const n = parseRest(inputEl.value);
        if(n === null) return;
        state[teamKey].rest = n; // ersetzt
        inputEl.value = "";
        render();
      }

      [ [el.restInputA,'A'], [el.restInputB,'B'] ].forEach(([inp, team]) => {
        inp.addEventListener('keydown', (e) => {
          if(e.key === 'Enter'){ e.preventDefault(); commitRest(team, inp); inp.blur(); }
        });
        inp.addEventListener('blur', () => commitRest(team, inp));
      });

      el.btnReset.addEventListener('click', () => {
        const ok = confirm("Wirklich alles zurücksetzen?");
        if(!ok) return;

        state.subtract = false;
        state.A = { c100:0, c50:0, c20:0, rest:0 };
        state.B = { c100:0, c50:0, c20:0, rest:0 };
        el.restInputA.value = "";
        el.restInputB.value = "";
        render();
      });

      render();
    })();
  </script>
</body>
</html>
