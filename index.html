<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Jass – Schiefertafel</title>
  <style>
    :root{
      --slate1:#0f1a14;
      --slate2:#0b1410;
      --chalk:#f3f6f1;
      --line:rgba(243,246,241,.26);
      --line-strong:rgba(243,246,241,.42);
      --glass:rgba(0,0,0,.18);
      --danger: rgba(255,120,120,.75);

      --panel: rgba(8,12,10,.94);
      --panel2: rgba(0,0,0,.88);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--chalk);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--slate1), var(--slate2));
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    .wrap{
      width:min(980px, 100%);
      padding: env(safe-area-inset-top) 10px env(safe-area-inset-bottom) 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }

    button{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--chalk);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      min-width: 112px;
    }
    button:active{ transform: scale(.98); }
    button[disabled]{ opacity:.45; cursor:not-allowed; }

    .toggle.on{
      border-color: rgba(255,255,255,.55);
      background: rgba(255,255,255,.10);
    }
    .toggle.on.subtract{
      border-color: var(--danger);
      background: rgba(255,120,120,.12);
    }

    .board{
      flex:1;
      border:2px solid var(--line-strong);
      border-radius:22px;
      overflow:hidden;
      background:
        radial-gradient(900px 500px at 30% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(800px 450px at 80% 70%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.18));
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:relative;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    /* Punktestand-Chips: weiter weg vom Zentrum */
    .sumChip{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
      pointer-events:none;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .sumChip.top{
      top: calc(50% - 82px);
      transform: translateX(-50%) rotate(180deg);
    }
    .sumChip.bottom{
      top: calc(50% + 52px);
    }
    .sumLabel{ opacity:.85; font-weight:900; font-size:13px; letter-spacing:.15px; }
    .sumNum{ font-variant-numeric: tabular-nums; font-weight:1000; font-size:16px; }

    /* ZENTRALE Buttons */
    .midControls{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      z-index: 6;
      pointer-events:none;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .midBtn{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.55);
      padding: 12px 16px;
      border-radius:999px;
      font-weight:1000;
      font-size:14px;
      min-width:auto;
      box-shadow: 0 18px 46px rgba(0,0,0,.50);
      backdrop-filter: blur(6px);
    }
    .midBtn.primary{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.45);
    }
    .midBtn.hidden{ display:none; }

    .divider{ height:2px; background: var(--line-strong); flex:0 0 auto; }

    .teamPanel{
      flex:1 1 0;
      display:grid;
      grid-template-columns: 1fr 84px;
      grid-template-rows: 1fr 1fr 1fr;
      gap:8px;
      padding:10px;
      min-height:0;
    }
    .teamPanel.top{
      transform: rotate(180deg);
      transform-origin: center;
    }

    .zone{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      align-items:stretch;
      min-height:0;
      user-select:none;
      touch-action: manipulation;
      overflow:hidden;
    }
    .zone:active{ transform: scale(.99); }

    .write{
      width:100%;
      display:flex;
      align-items:flex-end;
      gap:6px;
      padding: 4px 2px 2px 2px;
      overflow-x:auto;
      overflow-y:hidden;
      flex-wrap:nowrap;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .write::-webkit-scrollbar{ display:none; }

    /* 100/20: 5er-Striche */
    .group{ width:24px; height:44px; position:relative; opacity:.95; flex: 0 0 auto; }
    .stroke{
      position:absolute; bottom:0; width:3px; height:44px;
      background: var(--chalk); border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
    }
    .s1{ left:1px; } .s2{ left:7px; } .s3{ left:13px; } .s4{ left:19px; }
    .diag{
      position:absolute; left:-1px; bottom:7px; width:26px; height:4px;
      background: var(--chalk); border-radius:2px;
      transform: rotate(-28deg); transform-origin:left center;
    }

    /* 50er: Kreuze dicht */
    .mark50{ width:16px; height:44px; position:relative; opacity:.95; flex: 0 0 auto; margin-right:1px; }
    .slash{
      position:absolute; left:50%; top:4px; width:4px; height:38px;
      background: var(--chalk); border-radius:2px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.25));
      transform-origin:center;
    }
    .slash.fwd{ transform: translateX(-54%) rotate(-20deg); }
    .slash.back{ transform: translateX(-46%) rotate(20deg); }

    .restCol{
      border:1px solid var(--line);
      border-radius:18px;
      background: var(--glass);
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
      justify-content:flex-start;
    }
    .restValue{
      text-align:right;
      font-weight:1000;
      font-size:15px;
      min-height: 18px;
      opacity:.95;
      font-variant-numeric: tabular-nums;
    }
    input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--chalk);
      padding:10px 7px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      outline:none;
    }
    .mutedEmpty{ opacity:0; }

    .z100{ grid-column:1; grid-row:1; }
    .rest{ grid-column:2; grid-row:1; }
    .z50{ grid-column:1 / 3; grid-row:2; }
    .z20{ grid-column:1 / 3; grid-row:3; }

    /* improved */
    .mode-improved .zone{ pointer-events:none; }
    .mode-improved .restCol input{ display:none; }

    /* ---------- MODALS (kompakter + ohne Scroll nötig) ---------- */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.74);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 10px;
      z-index: 50;
    }
    .modalBackdrop.open{ display:flex; }

    .modal{
      width: min(520px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .modalTitle{ font-weight:1000; letter-spacing:.2px; font-size:14px; }
    .modalClose{
      min-width:auto;
      padding: 7px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      font-size: 13px;
    }

    .modalBody{
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .label{
      font-weight: 900;
      font-size: 11px;
      opacity: .85;
      letter-spacing: .1px;
    }
    .num{
      width:100%;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--chalk);
      padding: 9px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      outline:none;
    }

    /* 2-spaltiges Layout, damit weniger Höhe */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      align-items:end;
    }

    .checks{
      display:flex;
      gap:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 14px;
      align-items:center;
      justify-content:space-between;
    }
    .check{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight: 900;
      font-size: 12px;
      opacity: .95;
      user-select:none;
      white-space:nowrap;
    }
    .check input{ width:18px; height:18px; }

    .modalFooter{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    .primary{
      border-color: rgba(255,255,255,.40);
      background: rgba(255,255,255,.12);
    }

    .hintBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding: 8px 10px;
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-weight:900;
      font-size:12px;
      line-height:1.18;
      font-variant-numeric: tabular-nums;
    }
    .hintRow{ opacity:.92; }
    .hintSmall{ opacity:.75; font-size:11px; }

    /* segmented */
    .seg{
      display:flex;
      gap:8px;
      width:100%;
      flex-wrap:nowrap;
    }
    .segBtn{
      flex:1 1 0;
      min-width: 0;
      padding: 9px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      font-weight: 1000;
      text-align:center;
    }
    .segBtn.active{
      border-color: rgba(255,255,255,.45);
      background: rgba(255,255,255,.14);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    /* Weis-Punkte: 5 Buttons -> wrap in 2 Reihen, spart Breite ohne viel Höhe */
    .segWrap{ flex-wrap:wrap; }
    .segWrap .segBtn{ flex: 1 1 30%; }

    @media (max-width: 420px){
      .teamPanel{ grid-template-columns: 1fr 78px; gap:7px; padding:9px; }
      .sumChip{ font-size:15px; }
      .group{ width:22px; height:42px; }
      .stroke{ height:42px; }
      .diag{ width:24px; }
      .mark50{ width:15px; height:42px; }
      .slash{ height:36px; }
      .write{ gap:5px; }
      button{ min-width: 96px; }
      .midBtn{ padding: 11px 14px; font-size:13px; }

      .modal{ width: 100%; border-radius: 16px; }
      .grid2{ grid-template-columns: 1fr; } /* auf sehr kleinen Screens untereinander */
      .checks{ flex-direction:column; align-items:flex-start; gap:8px; }
      .segWrap .segBtn{ flex: 1 1 45%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <button class="toggle" id="btnMode" aria-pressed="false">Korrektur</button>
      <button id="btnReset">Reset</button>
      <button id="btnUndo">Undo</button>
      <button id="btnSettings">Einstellungen</button>
    </div>

    <div class="board" id="board" role="application" aria-label="Jass Schiefertafel">
      <div class="sumChip top">
        <span class="sumLabel">Oben</span>
        <span class="sumNum" id="sumTop">0</span>
      </div>
      <div class="sumChip bottom">
        <span class="sumLabel">Unten</span>
        <span class="sumNum" id="sumBottom">0</span>
      </div>

      <div class="midControls">
        <button class="midBtn primary hidden" id="btnAddRoundCenter">+ Runde</button>
        <button class="midBtn hidden" id="btnAddWeisCenter">+ Weis</button>
      </div>

      <!-- OBEN -->
      <div class="teamPanel top" data-team="A" aria-label="Oben">
        <div class="zone z100" data-team="A" data-val="100"><div class="write" id="a100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restA"></div>
          <input id="restInputA" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="A" data-val="50"><div class="write" id="a50W"></div></div>
        <div class="zone z20" data-team="A" data-val="20"><div class="write" id="a20W"></div></div>
      </div>

      <div class="divider"></div>

      <!-- UNTEN -->
      <div class="teamPanel" data-team="B" aria-label="Unten">
        <div class="zone z100" data-team="B" data-val="100"><div class="write" id="b100W"></div></div>
        <div class="restCol rest">
          <div class="restValue" id="restB"></div>
          <input id="restInputB" type="text" inputmode="text" placeholder="Neuer Restbetrag" autocomplete="off" />
        </div>
        <div class="zone z50" data-team="B" data-val="50"><div class="write" id="b50W"></div></div>
        <div class="zone z20" data-team="B" data-val="20"><div class="write" id="b20W"></div></div>
      </div>
    </div>
  </div>

  <!-- MODAL: Einstellungen -->
  <div class="modalBackdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Einstellungen">
      <div class="modalHeader">
        <div class="modalTitle">Einstellungen</div>
        <button class="modalClose" id="btnCloseSettings">Schliessen</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <div class="label">Zählmodus</div>
          <select class="num" id="modeSelect">
            <option value="improved">Verbesserte Zählweise (Standard)</option>
            <option value="classic">Klassische Tafel</option>
          </select>
        </div>
        <div class="hintBox">
          <div class="hintRow">Verbessert: + Runde / + Weis → Striche werden addiert (bestehende bleiben).</div>
          <div class="hintRow">Zusatzregel: sobald Rest ≥ 20 → 20 wegnehmen + 20er-Strich hinzufügen.</div>
        </div>
      </div>
      <div class="modalFooter">
        <button id="btnCloseSettings2">Schliessen</button>
        <button id="btnSaveSettings" class="primary">Speichern</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Runde hinzufügen -->
  <div class="modalBackdrop" id="roundModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Runde hinzufügen">
      <div class="modalHeader">
        <div class="modalTitle">+ Runde</div>
        <button class="modalClose" id="btnCloseRound">Schliessen</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div class="field">
            <div class="label">Team</div>
            <div class="seg" id="teamSegRound">
              <button class="segBtn active" data-team="B" type="button">Unten</button>
              <button class="segBtn" data-team="A" type="button">Oben</button>
            </div>
          </div>

          <div class="field">
            <div class="label">Multiplikator</div>
            <div class="seg" id="multSegRound">
              <button class="segBtn active" data-m="1" type="button">1×</button>
              <button class="segBtn" data-m="2" type="button">2×</button>
              <button class="segBtn" data-m="3" type="button">3×</button>
              <button class="segBtn" data-m="4" type="button">4×</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">Gemachte Punkte</div>
          <input class="num" id="inpPoints" inputmode="numeric" autocomplete="off" placeholder="z.B. 84" />
        </div>

        <div class="checks">
          <label class="check">
            <input type="checkbox" id="chkAutoOpp" checked />
            Auto-Gegner (157)
          </label>
          <label class="check">
            <input type="checkbox" id="chkMatch" />
            Match (257/0)
          </label>
        </div>

        <div class="hintBox" id="roundHint"></div>
      </div>

      <div class="modalFooter">
        <button id="btnCloseRound2">Schliessen</button>
        <button id="btnAddRound" class="primary">Hinzufügen</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Weis hinzufügen -->
  <div class="modalBackdrop" id="weisModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Weis hinzufügen">
      <div class="modalHeader">
        <div class="modalTitle">+ Weis</div>
        <button class="modalClose" id="btnCloseWeis">Schliessen</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div class="field">
            <div class="label">Team</div>
            <div class="seg" id="teamSegWeis">
              <button class="segBtn active" data-team="B" type="button">Unten</button>
              <button class="segBtn" data-team="A" type="button">Oben</button>
            </div>
          </div>

          <div class="field">
            <div class="label">Multiplikator</div>
            <div class="seg" id="multSegWeis">
              <button class="segBtn active" data-m="1" type="button">1×</button>
              <button class="segBtn" data-m="2" type="button">2×</button>
              <button class="segBtn" data-m="3" type="button">3×</button>
              <button class="segBtn" data-m="4" type="button">4×</button>
            </div>
          </div>
        </div>

        <div class="field">
          <div class="label">Weis Punkte</div>
          <div class="seg segWrap" id="weisSeg">
            <button class="segBtn active" data-w="20" type="button">20</button>
            <button class="segBtn" data-w="50" type="button">50</button>
            <button class="segBtn" data-w="100" type="button">100</button>
            <button class="segBtn" data-w="150" type="button">150</button>
            <button class="segBtn" data-w="200" type="button">200</button>
          </div>
        </div>

        <div class="hintBox" id="weisHint"></div>
      </div>

      <div class="modalFooter">
        <button id="btnCloseWeis2">Schliessen</button>
        <button id="btnAddWeis" class="primary">Hinzufügen</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const LS_KEY_MODE = "jass_mode_v6";

      const state = {
        mode: "improved", // default
        subtract: false,

        // board state = strokes already written + rest
        A: { c100: 0, c50: 0, c20: 0, rest: 0 },
        B: { c100: 0, c50: 0, c20: 0, rest: 0 },

        ui: {
          roundTeam: "B",
          roundMult: 1,
          weisTeam: "B",
          weisValue: 20,
          weisMult: 1
        },

        // undo snapshot of whole board (last action)
        lastAction: null
      };

      const el = {
        board: document.getElementById('board'),

        btnMode: document.getElementById('btnMode'),
        btnReset: document.getElementById('btnReset'),
        btnUndo: document.getElementById('btnUndo'),
        btnSettings: document.getElementById('btnSettings'),

        btnAddRoundCenter: document.getElementById('btnAddRoundCenter'),
        btnAddWeisCenter: document.getElementById('btnAddWeisCenter'),

        sumTop: document.getElementById('sumTop'),
        sumBottom: document.getElementById('sumBottom'),

        restA: document.getElementById('restA'),
        restB: document.getElementById('restB'),
        restInputA: document.getElementById('restInputA'),
        restInputB: document.getElementById('restInputB'),

        a100W: document.getElementById('a100W'),
        a50W: document.getElementById('a50W'),
        a20W: document.getElementById('a20W'),
        b100W: document.getElementById('b100W'),
        b50W: document.getElementById('b50W'),
        b20W: document.getElementById('b20W'),

        // settings modal
        settingsModal: document.getElementById('settingsModal'),
        btnCloseSettings: document.getElementById('btnCloseSettings'),
        btnCloseSettings2: document.getElementById('btnCloseSettings2'),
        btnSaveSettings: document.getElementById('btnSaveSettings'),
        modeSelect: document.getElementById('modeSelect'),

        // round modal
        roundModal: document.getElementById('roundModal'),
        btnCloseRound: document.getElementById('btnCloseRound'),
        btnCloseRound2: document.getElementById('btnCloseRound2'),
        btnAddRound: document.getElementById('btnAddRound'),
        inpPoints: document.getElementById('inpPoints'),
        chkAutoOpp: document.getElementById('chkAutoOpp'),
        chkMatch: document.getElementById('chkMatch'),
        roundHint: document.getElementById('roundHint'),
        teamSegRound: document.getElementById('teamSegRound'),
        multSegRound: document.getElementById('multSegRound'),

        // weis modal
        weisModal: document.getElementById('weisModal'),
        btnCloseWeis: document.getElementById('btnCloseWeis'),
        btnCloseWeis2: document.getElementById('btnCloseWeis2'),
        btnAddWeis: document.getElementById('btnAddWeis'),
        weisHint: document.getElementById('weisHint'),
        teamSegWeis: document.getElementById('teamSegWeis'),
        weisSeg: document.getElementById('weisSeg'),
        multSegWeis: document.getElementById('multSegWeis'),
      };

      // ---------- helpers ----------
      function clampMinZero(n){ return Math.max(0, n); }
      function teamSum(t){ return (t.c100*100) + (t.c50*50) + (t.c20*20) + (t.rest || 0); }

      function cloneTeam(t){ return { c100:t.c100, c50:t.c50, c20:t.c20, rest:t.rest }; }
      function snapshotBoard(){
        return { A: cloneTeam(state.A), B: cloneTeam(state.B) };
      }
      function restoreBoard(snap){
        if(!snap) return;
        state.A = cloneTeam(snap.A);
        state.B = cloneTeam(snap.B);
      }

      function openModal(backdropEl){
        backdropEl.classList.add('open');
        backdropEl.setAttribute('aria-hidden','false');
      }
      function closeModal(backdropEl){
        backdropEl.classList.remove('open');
        backdropEl.setAttribute('aria-hidden','true');
      }

      function loadMode(){
        const v = localStorage.getItem(LS_KEY_MODE);
        if(v === "classic" || v === "improved") state.mode = v;
      }
      function saveMode(){
        localStorage.setItem(LS_KEY_MODE, state.mode);
      }

      function parseNumber(text){
        const s = (text ?? "").toString().trim().replace(",", ".");
        if(!s) return null;
        const n = Number(s);
        if(!Number.isFinite(n)) return null;
        return Math.round(n);
      }

      // Zusatzregel: sobald Rest >= 20 -> 20 weg + 20er-Strich +1 (wiederholen)
      function normalizeRestTo20(team){
        team.rest = Number(team.rest || 0);
        if(!Number.isFinite(team.rest)) team.rest = 0;
        while(team.rest >= 20){
          team.rest -= 20;
          team.c20 += 1;
        }
        team.rest = clampMinZero(team.rest);
        team.c20 = clampMinZero(team.c20);
      }

      // Decompose ONLY the added points into strokes/rest (largest possible for the DELTA)
      function decomposeDelta(points){
        let s = Math.max(0, Math.round(points || 0));
        const c100 = Math.floor(s / 100); s -= c100 * 100;
        const c50  = Math.floor(s / 50);  s -= c50  * 50;
        const c20  = Math.floor(s / 20);  s -= c20  * 20;
        const rest = s;
        return { c100, c50, c20, rest };
      }

      // Add delta strokes (KEEP existing strokes as-is), then apply rest>=20 rule
      function addDeltaToTeam(teamKey, delta){
        const t = state[teamKey];
        t.c100 += delta.c100;
        t.c50  += delta.c50;
        t.c20  += delta.c20;
        t.rest += delta.rest;

        t.c100 = clampMinZero(t.c100);
        t.c50  = clampMinZero(t.c50);
        t.c20  = clampMinZero(t.c20);
        t.rest = clampMinZero(t.rest);

        normalizeRestTo20(t);
      }

      // ---------- tally drawing ----------
      function makeTallyGroup(countInGroup){
        const g = document.createElement('div');
        g.className = 'group';
        if(countInGroup >= 1){ const s=document.createElement('div'); s.className='stroke s1'; g.appendChild(s); }
        if(countInGroup >= 2){ const s=document.createElement('div'); s.className='stroke s2'; g.appendChild(s); }
        if(countInGroup >= 3){ const s=document.createElement('div'); s.className='stroke s3'; g.appendChild(s); }
        if(countInGroup >= 4){ const s=document.createElement('div'); s.className='stroke s4'; g.appendChild(s); }
        if(countInGroup >= 5){ const d=document.createElement('div'); d.className='diag'; g.appendChild(d); }
        return g;
      }

      function renderTalliesTo(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const fullGroups = Math.floor(n / 5);
        const rest = n % 5;

        for(let i=0; i<fullGroups; i++) hostEl.appendChild(makeTallyGroup(5));
        if(rest > 0) hostEl.appendChild(makeTallyGroup(rest));
      }

      function makeMark50(type){
        const m = document.createElement('div');
        m.className = 'mark50';

        const a = document.createElement('div');
        a.className = 'slash fwd';
        m.appendChild(a);

        if(type === 'cross'){
          const b = document.createElement('div');
          b.className = 'slash back';
          m.appendChild(b);
        }
        return m;
      }

      function render50To(hostEl, n){
        hostEl.innerHTML = "";
        if(!n || n <= 0) return;

        const pairs = Math.floor(n / 2);
        const odd = n % 2;

        for(let i=0;i<pairs;i++) hostEl.appendChild(makeMark50('cross'));
        if(odd === 1) hostEl.appendChild(makeMark50('slash'));
      }

      function setMaybeEmptyText(elm, value){
        if(!value){
          elm.textContent = "";
          elm.classList.add('mutedEmpty');
        } else {
          elm.textContent = String(value);
          elm.classList.remove('mutedEmpty');
        }
      }

      // ---------- classic click behavior ----------
      function bumpCount(teamKey, val){
        const t = state[teamKey];
        const delta = state.subtract ? -1 : 1;

        if(val === 100) t.c100 = clampMinZero(t.c100 + delta);
        if(val === 50)  t.c50  = clampMinZero(t.c50  + delta);
        if(val === 20)  t.c20  = clampMinZero(t.c20  + delta);

        render();
      }

      function parseRest(text){
        const s = (text ?? "").toString().trim().replace(",", ".");
        if(!s) return null;
        const n = Number(s);
        if(Number.isNaN(n)) return null;
        return n;
      }

      function commitRest(teamKey, inputEl){
        const n = parseRest(inputEl.value);
        if(n === null) return;
        state[teamKey].rest = n; // replaces rest
        inputEl.value = "";
        normalizeRestTo20(state[teamKey]);
        render();
      }

      // ---------- segmented helper ----------
      function setActiveSeg(container, matchFn){
        [...container.querySelectorAll('.segBtn')].forEach(btn => {
          btn.classList.toggle('active', matchFn(btn));
        });
      }

      // ---------- Round modal logic ----------
      function updateRoundHint(){
        const mult = state.ui.roundMult;
        const isMatch = el.chkMatch.checked;
        const autoOpp = el.chkAutoOpp.checked;
        const teamKey = state.ui.roundTeam;

        if(isMatch){
          const ownBase = 257;
          const ownAdd = ownBase * mult;
          el.inpPoints.disabled = true;
          el.chkAutoOpp.disabled = true;

          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: 0</div>
            <div class="hintSmall">Rest-Regel aktiv: Rest ≥ 20 → wird zu 20er-Strich.</div>
          `;
          return;
        }

        el.inpPoints.disabled = false;
        el.chkAutoOpp.disabled = false;

        const pts = parseNumber(el.inpPoints.value);
        if(pts === null){
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: —</div>
            <div class="hintRow">Gegner: ${autoOpp ? "157 − Eigen (auto)" : "—"}</div>
            <div class="hintSmall">Multiplikator: ×${mult}</div>
          `;
          return;
        }

        const ownBase = pts;
        const ownAdd = ownBase * mult;

        if(autoOpp){
          const oppBase = Math.max(0, 157 - ownBase);
          const oppAdd = oppBase * mult;
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: ${oppBase} × ${mult} = ${oppAdd}</div>
            <div class="hintSmall">Rest-Regel aktiv: Rest ≥ 20 → wird zu 20er-Strich.</div>
          `;
        } else {
          el.roundHint.innerHTML = `
            <div class="hintRow">Eigen: ${ownBase} × ${mult} = ${ownAdd}</div>
            <div class="hintRow">Gegner: —</div>
            <div class="hintSmall">Rest-Regel aktiv: Rest ≥ 20 → wird zu 20er-Strich.</div>
          `;
        }
      }

      function openRoundModal(){
        state.ui.roundTeam = "B";
        state.ui.roundMult = 1;
        el.inpPoints.value = "";
        el.chkAutoOpp.checked = true;
        el.chkMatch.checked = false;

        setActiveSeg(el.teamSegRound, b => b.dataset.team === state.ui.roundTeam);
        setActiveSeg(el.multSegRound, b => Number(b.dataset.m) === state.ui.roundMult);

        updateRoundHint();
        openModal(el.roundModal);
        setTimeout(() => el.inpPoints.focus(), 60);
      }

      function addRound(){
        const mult = state.ui.roundMult;
        const isMatch = el.chkMatch.checked;
        const autoOpp = el.chkAutoOpp.checked;

        const teamKey = state.ui.roundTeam;
        const oppKey = (teamKey === "A") ? "B" : "A";

        let ownAdd = 0;
        let oppAdd = 0;

        if(isMatch){
          ownAdd = 257 * mult;
        } else {
          const pts = parseNumber(el.inpPoints.value);
          if(pts === null){
            alert("Bitte Punkte eingeben (oder Match aktivieren).");
            return;
          }
          if(pts < 0 || pts > 257){
            alert("Punkte müssen zwischen 0 und 257 liegen.");
            return;
          }
          ownAdd = pts * mult;
          if(autoOpp){
            const oppBase = Math.max(0, 157 - pts);
            oppAdd = oppBase * mult;
          }
        }

        // snapshot for Undo (exact restore, incl. rest-carry behaviour)
        state.lastAction = { prev: snapshotBoard() };

        addDeltaToTeam(teamKey, decomposeDelta(ownAdd));
        if(oppAdd > 0) addDeltaToTeam(oppKey, decomposeDelta(oppAdd));

        closeModal(el.roundModal);
        render();
      }

      // ---------- Weis modal logic ----------
      function updateWeisHint(){
        const w = state.ui.weisValue;
        const m = state.ui.weisMult;
        const add = w * m;

        el.weisHint.innerHTML = `
          <div class="hintRow">Weis: ${w} × ${m} = ${add}</div>
          <div class="hintSmall">Rest-Regel aktiv: Rest ≥ 20 → wird zu 20er-Strich.</div>
        `;
      }

      function openWeisModal(){
        state.ui.weisTeam = "B";
        state.ui.weisValue = 20;
        state.ui.weisMult = 1;

        setActiveSeg(el.teamSegWeis, b => b.dataset.team === state.ui.weisTeam);
        setActiveSeg(el.weisSeg, b => Number(b.dataset.w) === state.ui.weisValue);
        setActiveSeg(el.multSegWeis, b => Number(b.dataset.m) === state.ui.weisMult);

        updateWeisHint();
        openModal(el.weisModal);
      }

      function addWeis(){
        const teamKey = state.ui.weisTeam;
        const add = state.ui.weisValue * state.ui.weisMult;

        state.lastAction = { prev: snapshotBoard() };
        addDeltaToTeam(teamKey, decomposeDelta(add));

        closeModal(el.weisModal);
        render();
      }

      // ---------- Undo ----------
      function undoLast(){
        if(!state.lastAction?.prev) return;
        restoreBoard(state.lastAction.prev);
        state.lastAction = null;
        render();
      }

      // ---------- render ----------
      function applyModeUI(){
        const isImproved = (state.mode === "improved");
        el.board.classList.toggle("mode-improved", isImproved);

        el.btnMode.style.display = isImproved ? "none" : "";
        el.btnMode.disabled = isImproved;

        el.btnAddRoundCenter.classList.toggle("hidden", !isImproved);
        el.btnAddWeisCenter.classList.toggle("hidden", !isImproved);

        el.modeSelect.value = state.mode;
        if(isImproved) state.subtract = false;

        el.btnUndo.disabled = !state.lastAction;
      }

      function render(){
        applyModeUI();

        renderTalliesTo(el.a100W, state.A.c100);
        render50To(el.a50W, state.A.c50);
        renderTalliesTo(el.a20W, state.A.c20);

        renderTalliesTo(el.b100W, state.B.c100);
        render50To(el.b50W, state.B.c50);
        renderTalliesTo(el.b20W, state.B.c20);

        setMaybeEmptyText(el.restA, state.A.rest);
        setMaybeEmptyText(el.restB, state.B.rest);

        el.sumTop.textContent = String(teamSum(state.A));
        el.sumBottom.textContent = String(teamSum(state.B));

        el.btnMode.classList.toggle('on', state.subtract);
        el.btnMode.classList.toggle('subtract', state.subtract);
        el.btnMode.setAttribute('aria-pressed', String(state.subtract));
        el.btnMode.textContent = state.subtract ? 'Korrektur: AN' : 'Korrektur';
      }

      // ---------- events ----------
      document.querySelectorAll('.zone').forEach(z => {
        z.addEventListener('click', () => {
          if(state.mode !== "classic") return;
          bumpCount(z.dataset.team, Number(z.dataset.val));
        }, { passive:true });
      });

      el.btnMode.addEventListener('click', () => {
        if(state.mode !== "classic") return;
        state.subtract = !state.subtract;
        render();
      });

      [ [el.restInputA,'A'], [el.restInputB,'B'] ].forEach(([inp, team]) => {
        inp.addEventListener('keydown', (e) => {
          if(e.key === 'Enter'){ e.preventDefault(); commitRest(team, inp); inp.blur(); }
        });
        inp.addEventListener('blur', () => commitRest(team, inp));
      });

      el.btnReset.addEventListener('click', () => {
        const ok = confirm("Wirklich alles zurücksetzen?");
        if(!ok) return;

        state.subtract = false;
        state.A = { c100:0, c50:0, c20:0, rest:0 };
        state.B = { c100:0, c50:0, c20:0, rest:0 };
        state.lastAction = null;

        el.restInputA.value = "";
        el.restInputB.value = "";
        render();
      });

      el.btnUndo.addEventListener('click', undoLast);

      // settings
      el.btnSettings.addEventListener('click', () => openModal(el.settingsModal));
      const closeSettings = () => closeModal(el.settingsModal);
      el.btnCloseSettings.addEventListener('click', closeSettings);
      el.btnCloseSettings2.addEventListener('click', closeSettings);
      el.settingsModal.addEventListener('click', (e) => { if(e.target === el.settingsModal) closeSettings(); });

      el.btnSaveSettings.addEventListener('click', () => {
        const v = el.modeSelect.value;
        state.mode = (v === "classic") ? "classic" : "improved";
        saveMode();
        closeSettings();
        render();
      });

      // central buttons
      el.btnAddRoundCenter.addEventListener('click', openRoundModal);
      el.btnAddWeisCenter.addEventListener('click', openWeisModal);

      // round modal
      const closeRound = () => closeModal(el.roundModal);
      el.btnCloseRound.addEventListener('click', closeRound);
      el.btnCloseRound2.addEventListener('click', closeRound);
      el.roundModal.addEventListener('click', (e) => { if(e.target === el.roundModal) closeRound(); });

      el.teamSegRound.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.roundTeam = btn.dataset.team;
        setActiveSeg(el.teamSegRound, b => b === btn);
        updateRoundHint();
      });
      el.multSegRound.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.roundMult = Number(btn.dataset.m) || 1;
        setActiveSeg(el.multSegRound, b => b === btn);
        updateRoundHint();
      });
      el.inpPoints.addEventListener('input', updateRoundHint);
      el.chkAutoOpp.addEventListener('change', updateRoundHint);
      el.chkMatch.addEventListener('change', updateRoundHint);
      el.btnAddRound.addEventListener('click', addRound);
      el.inpPoints.addEventListener('keydown', (e) => {
        if(e.key === "Enter"){ e.preventDefault(); addRound(); }
      });

      // weis modal
      const closeWeis = () => closeModal(el.weisModal);
      el.btnCloseWeis.addEventListener('click', closeWeis);
      el.btnCloseWeis2.addEventListener('click', closeWeis);
      el.weisModal.addEventListener('click', (e) => { if(e.target === el.weisModal) closeWeis(); });

      el.teamSegWeis.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.weisTeam = btn.dataset.team;
        setActiveSeg(el.teamSegWeis, b => b === btn);
        updateWeisHint();
      });
      el.weisSeg.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.weisValue = Number(btn.dataset.w) || 20;
        setActiveSeg(el.weisSeg, b => b === btn);
        updateWeisHint();
      });
      el.multSegWeis.addEventListener('click', (e) => {
        const btn = e.target.closest('.segBtn');
        if(!btn) return;
        state.ui.weisMult = Number(btn.dataset.m) || 1;
        setActiveSeg(el.multSegWeis, b => b === btn);
        updateWeisHint();
      });
      el.btnAddWeis.addEventListener('click', addWeis);

      // ESC closes modals
      document.addEventListener('keydown', (e) => {
        if(e.key === "Escape"){
          closeSettings();
          closeRound();
          closeWeis();
        }
      });

      // init
      loadMode();
      if(state.mode !== "classic" && state.mode !== "improved") state.mode = "improved";
      render();
    })();
  </script>
</body>
</html>
